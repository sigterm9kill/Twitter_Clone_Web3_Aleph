"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Serialization = exports.Serializable = exports.SERIALIZATIONVERSION = void 0;
/**
 * @packageDocumentation
 * @module Utils-Serialization
 */
const bintools_1 = __importDefault(require("../utils/bintools"));
const bn_js_1 = __importDefault(require("bn.js"));
const buffer_1 = require("buffer/");
const helperfunctions_1 = require("./helperfunctions");
exports.SERIALIZATIONVERSION = 0;
class Serializable {
    constructor() {
        this._typeName = undefined;
        this._typeID = undefined;
    }
    /**
     * Used in serialization. TypeName is a string name for the type of object being output.
     */
    getTypeName() {
        return this._typeName;
    }
    /**
     * Used in serialization. Optional. TypeID is a number for the typeID of object being output.
     */
    getTypeID() {
        return this._typeID;
    }
    //sometimes the parent class manages the fields
    //these are so you can say super.serialize(encoding); 
    serialize(encoding) {
        return {
            "_typeName": this._typeName,
            "_typeID": (typeof this._typeID === "undefined" ? null : this._typeID)
        };
    }
    ;
    deserialize(fields, encoding) {
        if (typeof fields["_typeName"] !== "string") {
            throw new Error("Error - Serializable.deserialize: _typeName must be a string, found: " + typeof fields["_typeName"]);
        }
        if (fields["_typeName"] !== this._typeName) {
            throw new Error("Error - Serializable.deserialize: _typeName mismatch -- expected: " + this._typeName + " -- recieved: " + fields["_typeName"]);
        }
        if (typeof fields["_typeID"] !== "undefined" && fields["_typeID"] !== null) {
            if (typeof fields["_typeID"] !== "number") {
                throw new Error("Error - Serializable.deserialize: _typeID must be a number, found: " + typeof fields["_typeID"]);
            }
            if (fields["_typeID"] !== this._typeID) {
                throw new Error("Error - Serializable.deserialize: _typeID mismatch -- expected: " + this._typeID + " -- recieved: " + fields["_typeID"]);
            }
        }
    }
    ;
}
exports.Serializable = Serializable;
class Serialization {
    constructor() {
        this.bintools = bintools_1.default.getInstance();
    }
    /**
     * Retrieves the Serialization singleton.
     */
    static getInstance() {
        if (!Serialization.instance) {
            Serialization.instance = new Serialization();
        }
        return Serialization.instance;
    }
    bufferToType(vb, type, ...args) {
        if (type === "BN") {
            return new bn_js_1.default(vb.toString("hex"), "hex");
        }
        else if (type === "Buffer") {
            if (args.length == 1 && typeof args[0] === "number") {
                vb = buffer_1.Buffer.from(vb.toString("hex").padStart(args[0] * 2, '0'), "hex");
            }
            return vb;
        }
        else if (type === "bech32") {
            return this.bintools.addressToString(args[0], args[1], vb);
        }
        else if (type === "nodeID") {
            return helperfunctions_1.bufferToNodeIDString(vb);
        }
        else if (type === "privateKey") {
            return helperfunctions_1.bufferToPrivateKeyString(vb);
        }
        else if (type === "cb58") {
            return this.bintools.cb58Encode(vb);
        }
        else if (type === "base58") {
            return this.bintools.bufferToB58(vb);
        }
        else if (type === "base64") {
            return vb.toString("base64");
        }
        else if (type === "hex") {
            return vb.toString("hex");
        }
        else if (type === "decimalString") {
            return new bn_js_1.default(vb.toString("hex"), "hex").toString(10);
        }
        else if (type === "number") {
            return new bn_js_1.default(vb.toString("hex"), "hex").toNumber();
        }
        else if (type === "utf8") {
            return vb.toString("utf8");
        }
        return undefined;
    }
    typeToBuffer(v, type, ...args) {
        if (type === "BN") {
            let str = v.toString("hex");
            if (args.length == 1 && typeof args[0] === "number") {
                return buffer_1.Buffer.from(str.padStart(args[0] * 2, '0'), 'hex');
            }
            return buffer_1.Buffer.from(str, 'hex');
        }
        else if (type === "Buffer") {
            return v;
        }
        else if (type === "bech32") {
            return this.bintools.stringToAddress(v);
        }
        else if (type === "nodeID") {
            return helperfunctions_1.NodeIDStringToBuffer(v);
        }
        else if (type === "privateKey") {
            return helperfunctions_1.privateKeyStringToBuffer(v);
        }
        else if (type === "cb58") {
            return this.bintools.cb58Decode(v);
        }
        else if (type === "base58") {
            return this.bintools.b58ToBuffer(v);
        }
        else if (type === "base64") {
            return buffer_1.Buffer.from(v, "base64");
        }
        else if (type === "hex") {
            if (v.startsWith("0x")) {
                v = v.slice(2);
            }
            return buffer_1.Buffer.from(v, "hex");
        }
        else if (type === "decimalString") {
            let str = new bn_js_1.default(v, 10).toString("hex");
            if (args.length == 1 && typeof args[0] === "number") {
                return buffer_1.Buffer.from(str.padStart(args[0] * 2, '0'), 'hex');
            }
            return buffer_1.Buffer.from(str, 'hex');
        }
        else if (type === "number") {
            let str = new bn_js_1.default(v, 10).toString("hex");
            if (args.length == 1 && typeof args[0] === "number") {
                return buffer_1.Buffer.from(str.padStart(args[0] * 2, '0'), 'hex');
            }
            return buffer_1.Buffer.from(str, 'hex');
        }
        else if (type === "utf8") {
            if (args.length == 1 && typeof args[0] === "number") {
                let b = buffer_1.Buffer.alloc(args[0]);
                b.write(v);
                return b;
            }
            return buffer_1.Buffer.from(v, 'utf8');
        }
        return undefined;
    }
    encoder(value, encoding, intype, outtype, ...args) {
        if (typeof value === "undefined") {
            throw new Error("Error - Serializable.encoder: value passed is undefined");
        }
        if (encoding !== "display") {
            outtype = encoding;
        }
        let vb = this.typeToBuffer(value, intype, ...args);
        return this.bufferToType(vb, outtype, ...args);
    }
    decoder(value, encoding, intype, outtype, ...args) {
        if (typeof value === "undefined") {
            throw new Error("Error - Serializable.decoder: value passed is undefined");
        }
        if (encoding !== "display") {
            intype = encoding;
        }
        let vb = this.typeToBuffer(value, intype, ...args);
        return this.bufferToType(vb, outtype, ...args);
    }
    serialize(serialize, vm, encoding = "display", notes = undefined) {
        if (typeof notes === "undefined") {
            notes = serialize.getTypeName();
        }
        return {
            vm,
            encoding,
            version: exports.SERIALIZATIONVERSION,
            notes,
            fields: serialize.serialize(encoding)
        };
    }
    deserialize(input, output) {
        output.deserialize(input["fields"], input["encoding"]);
    }
}
exports.Serialization = Serialization;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VyaWFsaXphdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9zZXJpYWxpemF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOzs7R0FHRztBQUNILGlFQUF5QztBQUN6QyxrREFBdUI7QUFDdkIsb0NBQWlDO0FBQ2pDLHVEQUFtSTtBQUV0SCxRQUFBLG9CQUFvQixHQUFHLENBQUMsQ0FBQztBQTRCdEMsTUFBc0IsWUFBWTtJQUFsQztRQUNjLGNBQVMsR0FBVSxTQUFTLENBQUM7UUFDN0IsWUFBTyxHQUFVLFNBQVMsQ0FBQztJQXdDekMsQ0FBQztJQXRDRzs7T0FFRztJQUNILFdBQVc7UUFDUCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDMUIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsU0FBUztRQUNMLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQTtJQUN2QixDQUFDO0lBRUQsK0NBQStDO0lBQy9DLHNEQUFzRDtJQUN0RCxTQUFTLENBQUMsUUFBNEI7UUFDbEMsT0FBTztZQUNILFdBQVcsRUFBRSxJQUFJLENBQUMsU0FBUztZQUMzQixTQUFTLEVBQUUsQ0FBQyxPQUFPLElBQUksQ0FBQyxPQUFPLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7U0FDekUsQ0FBQTtJQUNMLENBQUM7SUFBQSxDQUFDO0lBQ0YsV0FBVyxDQUFDLE1BQWEsRUFBRSxRQUE0QjtRQUNuRCxJQUFHLE9BQU8sTUFBTSxDQUFDLFdBQVcsQ0FBQyxLQUFLLFFBQVEsRUFBRTtZQUN4QyxNQUFNLElBQUksS0FBSyxDQUFDLHVFQUF1RSxHQUFHLE9BQU8sTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7U0FDekg7UUFDRCxJQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ3ZDLE1BQU0sSUFBSSxL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RTtZQUNGLFFBQVE7WUFDUixPQUFPLEVBQUUsNEJBQW9CO1lBQzdCLEtBQUs7WUFDTCxNQUFNLEVBQUUsU0FBUyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7U0FDeEMsQ0FBQTtJQUNMLENBQUM7SUFFRCxXQUFXLENBQUMsS0FBWSxFQUFFLE1BQW1CO1FBQ3pDLE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQzNELENBQUM7Q0FDSjtBQTFJRCxzQ0EwSUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBwYWNrYWdlRG9jdW1lbnRhdGlvblxuICogQG1vZHVsZSBVdGlscy1TZXJpYWxpemF0aW9uXG4gKi9cbmltcG9ydCBCaW5Ub29scyBmcm9tICcuLi91dGlscy9iaW50b29scyc7XG5pbXBvcnQgQk4gZnJvbSAnYm4uanMnO1xuaW1wb3J0IHsgQnVmZmVyIH0gZnJvbSAnYnVmZmVyLyc7XG5pbXBvcnQgeyBOb2RlSURTdHJpbmdUb0J1ZmZlciwgcHJpdmF0ZUtleVN0cmluZ1RvQnVmZmVyLCBidWZmZXJUb05vZGVJRFN0cmluZywgYnVmZmVyVG9Qcml2YXRlS2V5U3RyaW5nIH0gZnJvbSAnLi9oZWxwZXJmdW5jdGlvbnMnO1xuXG5leHBvcnQgY29uc3QgU0VSSUFMSVpBVElPTlZFUlNJT04gPSAwO1xuXG5leHBvcnQgdHlwZSBTZXJpYWxpemVkVHlwZSA9IFxuICAnaGV4JyBcbnwgJ0JOJyBcbnwgJ0J1ZmZlcicgXG58ICdiZWNoMzInIFxufCAnbm9kZUlEJ1xufCAncHJpdmF0ZUtleSdcbnwgJ2NiNTgnIFxufCAnYmFzZTU4JyBcbnwgJ2Jhc2U2NCcgXG58ICdkZWNpbWFsU3RyaW5nJ1xufCAnbnVtYmVyJ1xufCAndXRmOCdcbjtcblxuZXhwb3J0IHR5cGUgU2VyaWFsaXplZEVuY29kaW5nID0gXG4gICdoZXgnIFxufCAnY2I1OCcgXG58ICdiYXNlNTgnIFxufCAnYmFzZTY0JyBcbnwgJ2RlY2ltYWxTdHJpbmcnXG58ICdudW1iZXInXG58ICd1dGY4J1xufCAnZGlzcGxheSdcbjtcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFNlcmlhbGl6YWJsZSB7XG4gICAgcHJvdGVjdGVkIF90eXBlTmFtZTpzdHJpbmcgPSB1bmRlZmluZWQ7XG4gICAgcHJvdGVjdGVkIF90eXBlSUQ6bnVtYmVyID0gdW5kZWZpbmVkO1xuXG4gICAgLyoqXG4gICAgICogVXNlZCBpbiBzZXJpYWxpemF0aW9uLiBUeXBlTmFtZSBpcyBhIHN0cmluZyBuYW1lIGZvciB0aGUgdHlwZSBvZiBvYmplY3QgYmVpbmcgb3V0cHV0LlxuICAgICAqL1xuICAgIGdldFR5cGVOYW1lKCk6c3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3R5cGVOYW1lO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVzZWQgaW4gc2VyaWFsaXphdGlvbi4gT3B0aW9uYWwuIFR5cGVJRCBpcyBhIG51bWJlciBmb3IgdGhlIHR5cGVJRCBvZiBvYmplY3QgYmVpbmcgb3V0cHV0LlxuICAgICAqL1xuICAgIGdldFR5cGVJRCgpOm51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLl90eXBlSURcbiAgICB9XG5cbiAgICAvL3NvbWV0aW1lcyB0aGUgcGFyZW50IGNsYXNzIG1hbmFnZXMgdGhlIGZpZWxkc1xuICAgIC8vdGhlc2UgYXJlIHNvIHlvdSBjYW4gc2F5IHN1cGVyLnNlcmlhbGl6ZShlbmNvZGluZyk7IFxuICAgIHNlcmlhbGl6ZShlbmNvZGluZz86U2VyaWFsaXplZEVuY29kaW5nKTpvYmplY3Qge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgXCJfdHlwZU5hbWVcIjogdGhpcy5fdHlwZU5hbWUsXG4gICAgICAgICAgICBcIl90eXBlSURcIjogKHR5cGVvZiB0aGlzLl90eXBlSUQgPT09IFwidW5kZWZpbmVkXCIgPyBudWxsIDogdGhpcy5fdHlwZUlEKVxuICAgICAgICB9XG4gICAgfTsgXG4gICAgZGVzZXJpYWxpemUoZmllbGRzOm9iamVjdCwgZW5jb2Rpbmc/OlNlcmlhbGl6ZWRFbmNvZGluZykge1xuICAgICAgICBpZih0eXBlb2YgZmllbGRzW1wiX3R5cGVOYW1lXCJdICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJFcnJvciAtIFNlcmlhbGl6YWJsZS5kZXNlcmlhbGl6ZTogX3R5cGVOYW1lIG11c3QgYmUgYSBzdHJpbmcsIGZvdW5kOiBcIiArIHR5cGVvZiBmaWVsZHNbXCJfdHlwZU5hbWVcIl0pO1xuICAgICAgICB9XG4gICAgICAgIGlmKGZpZWxkc1tcIl90eXBlTmFtZVwiXSAhPT0gdGhpcy5fdHlwZU5hbWUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkVycm9yIC0gU2VyaWFsaXphYmxlLmRlc2VyaWFsaXplOiBfdHlwZU5hbWUgbWlzbWF0Y2ggLS0gZXhwZWN0ZWQ6IFwiICsgdGhpcy5fdHlwZU5hbWUgKyBcIiAtLSByZWNpZXZlZDogXCIgKyBmaWVsZHNbXCJfdHlwZU5hbWVcIl0pO1xuICAgICAgICB9XG4gICAgICAgIGlmKHR5cGVvZiBmaWVsZHNbXCJfdHlwZUlEXCJdICE9PSBcInVuZGVmaW5lZFwiICYmIGZpZWxkc1tcIl90eXBlSURcIl0gIT09IG51bGwpIHtcbiAgICAgICAgICAgIGlmKHR5cGVvZiBmaWVsZHNbXCJfdHlwZUlEXCJdICE9PSBcIm51bWJlclwiKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXJyb3IgLSBTZXJpYWxpemFibGUuZGVzZXJpYWxpemU6IF90eXBlSUQgbXVzdCBiZSBhIG51bWJlciwgZm91bmQ6IFwiICsgdHlwZW9mIGZpZWxkc1tcIl90eXBlSURcIl0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYoZmllbGRzW1wiX3R5cGVJRFwiXSAhPT0gdGhpcy5fdHlwZUlEKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXJyb3IgLSBTZXJpYWxpemFibGUuZGVzZXJpYWxpemU6IF90eXBlSUQgbWlzbWF0Y2ggLS0gZXhwZWN0ZWQ6IFwiICsgdGhpcy5fdHlwZUlEICsgXCIgLS0gcmVjaWV2ZWQ6IFwiICsgZmllbGRzW1wiX3R5cGVJRFwiXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xufVxuXG5leHBvcnQgY2xhc3MgU2VyaWFsaXphdGlvbiB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6U2VyaWFsaXphdGlvbjtcbiAgXG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHtcbiAgICAgIHRoaXMuYmludG9vbHMgPSBCaW5Ub29scy5nZXRJbnN0YW5jZSgpO1xuICAgIH1cbiAgICBwcml2YXRlIGJpbnRvb2xzOkJpblRvb2xzO1xuXG4gICAgLyoqXG4gICAgICogUmV0cmlldmVzIHRoZSBTZXJpYWxpemF0aW9uIHNpbmdsZXRvbi5cbiAgICAgKi9cbiAgICBzdGF0aWMgZ2V0SW5zdGFuY2UoKTogU2VyaWFsaXphdGlvbiB7XG4gICAgICAgIGlmICghU2VyaWFsaXphdGlvbi5pbnN0YW5jZSkge1xuICAgICAgICAgICAgU2VyaWFsaXphdGlvbi5pbnN0YW5jZSA9IG5ldyBTZXJpYWxpemF0aW9uKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFNlcmlhbGl6YXRpb24uaW5zdGFuY2U7XG4gICAgfVxuXG4gICAgYnVmZmVyVG9UeXBlKHZiOkJ1ZmZlciwgdHlwZTpTZXJpYWxpemVkVHlwZSwgLi4uYXJnczpBcnJheTxhbnk+KTphbnkge1xuICAgICAgICBpZih0eXBlID09PSBcIkJOXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQk4odmIudG9TdHJpbmcoXCJoZXhcIiksIFwiaGV4XCIpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJCdWZmZXJcIikge1xuICAgICAgICAgICAgaWYoYXJncy5sZW5ndGggPT0gMSAmJiB0eXBlb2YgYXJnc1swXSA9PT0gXCJudW1iZXJcIil7XG4gICAgICAgICAgICAgICAgdmIgPSBCdWZmZXIuZnJvbSh2Yi50b1N0cmluZyhcImhleFwiKS5wYWRTdGFydChhcmdzWzBdICogMiwgJzAnKSwgXCJoZXhcIilcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB2YjtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwiYmVjaDMyXCIpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmJpbnRvb2xzLmFkZHJlc3NUb1N0cmluZyhhcmdzWzBdLCBhcmdzWzFdLCB2Yik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcIm5vZGVJRFwiKSB7XG4gICAgICAgICAgICByZXR1cm4gYnVmZmVyVG9Ob2RlSURTdHJpbmcodmIpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJwcml2YXRlS2V5XCIpIHtcbiAgICAgICAgICAgIHJldHVybiBidWZmZXJUb1ByaXZhdGVLZXlTdHJpbmcodmIpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJjYjU4XCIpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmJpbnRvb2xzLmNiNThFbmNvZGUodmIpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJiYXNlNThcIikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmludG9vbHMuYnVmZmVyVG9CNTgodmIpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJiYXNlNjRcIikge1xuICAgICAgICAgICAgcmV0dXJuIHZiLnRvU3RyaW5nKFwiYmFzZTY0XCIpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJoZXhcIikge1xuICAgICAgICAgICAgcmV0dXJuIHZiLnRvU3RyaW5nKFwiaGV4XCIpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJkZWNpbWFsU3RyaW5nXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQk4odmIudG9TdHJpbmcoXCJoZXhcIiksIFwiaGV4XCIpLnRvU3RyaW5nKDEwKTtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwibnVtYmVyXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQk4odmIudG9TdHJpbmcoXCJoZXhcIiksIFwiaGV4XCIpLnRvTnVtYmVyKCk7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcInV0ZjhcIikge1xuICAgICAgICAgICAgcmV0dXJuIHZiLnRvU3RyaW5nKFwidXRmOFwiKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHR5cGVUb0J1ZmZlcih2OmFueSwgdHlwZTpTZXJpYWxpemVkVHlwZSwgLi4uYXJnczpBcnJheTxhbnk+KTpCdWZmZXIge1xuICAgICAgICBpZih0eXBlID09PSBcIkJOXCIpIHtcbiAgICAgICAgICAgIGxldCBzdHI6c3RyaW5nID0gKHYgYXMgQk4pLnRvU3RyaW5nKFwiaGV4XCIpO1xuICAgICAgICAgICAgaWYoYXJncy5sZW5ndGggPT0gMSAmJiB0eXBlb2YgYXJnc1swXSA9PT0gXCJudW1iZXJcIil7XG4gICAgICAgICAgICAgICByZXR1cm4gQnVmZmVyLmZyb20oc3RyLnBhZFN0YXJ0KGFyZ3NbMF0gKiAyLCAnMCcpLCAnaGV4Jyk7IFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKHN0ciwgJ2hleCcpOyBcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwiQnVmZmVyXCIpIHtcbiAgICAgICAgICAgIHJldHVybiB2O1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJiZWNoMzJcIikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmludG9vbHMuc3RyaW5nVG9BZGRyZXNzKHYpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJub2RlSURcIikge1xuICAgICAgICAgICAgcmV0dXJuIE5vZGVJRFN0cmluZ1RvQnVmZmVyKHYpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJwcml2YXRlS2V5XCIpIHtcbiAgICAgICAgICAgIHJldHVybiBwcml2YXRlS2V5U3RyaW5nVG9CdWZmZXIodik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcImNiNThcIikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmludG9vbHMuY2I1OERlY29kZSh2KTtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwiYmFzZTU4XCIpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmJpbnRvb2xzLmI1OFRvQnVmZmVyKHYpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJiYXNlNjRcIikge1xuICAgICAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKHYgYXMgc3RyaW5nLCBcImJhc2U2NFwiKTtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwiaGV4XCIpIHtcbiAgICAgICAgICAgIGlmKCh2IGFzIHN0cmluZykuc3RhcnRzV2l0aChcIjB4XCIpKXtcbiAgICAgICAgICAgICAgICB2ID0gKHYgYXMgc3RyaW5nKS5zbGljZSgyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbSh2IGFzIHN0cmluZywgXCJoZXhcIik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcImRlY2ltYWxTdHJpbmdcIikge1xuICAgICAgICAgICAgbGV0IHN0cjpzdHJpbmcgPSBuZXcgQk4odiBhcyBzdHJpbmcsIDEwKS50b1N0cmluZyhcImhleFwiKTtcbiAgICAgICAgICAgIGlmKGFyZ3MubGVuZ3RoID09IDEgJiYgdHlwZW9mIGFyZ3NbMF0gPT09IFwibnVtYmVyXCIpe1xuICAgICAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShzdHIucGFkU3RhcnQoYXJnc1swXSAqIDIsICcwJyksICdoZXgnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShzdHIsICdoZXgnKTtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwibnVtYmVyXCIpIHtcbiAgICAgICAgICAgIGxldCBzdHI6c3RyaW5nID0gbmV3IEJOKHYsIDEwKS50b1N0cmluZyhcImhleFwiKTtcbiAgICAgICAgICAgIGlmKGFyZ3MubGVuZ3RoID09IDEgJiYgdHlwZW9mIGFyZ3NbMF0gPT09IFwibnVtYmVyXCIpe1xuICAgICAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShzdHIucGFkU3RhcnQoYXJnc1swXSAqIDIsICcwJyksICdoZXgnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShzdHIsICdoZXgnKTtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwidXRmOFwiKSB7XG4gICAgICAgICAgICBpZihhcmdzLmxlbmd0aCA9PSAxICYmIHR5cGVvZiBhcmdzWzBdID09PSBcIm51bWJlclwiKXtcbiAgICAgICAgICAgICAgICBsZXQgYjpCdWZmZXIgPSBCdWZmZXIuYWxsb2MoYXJnc1swXSk7XG4gICAgICAgICAgICAgICAgYi53cml0ZSh2KVxuICAgICAgICAgICAgICAgIHJldHVybiBiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKHYsICd1dGY4Jyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBlbmNvZGVyKHZhbHVlOmFueSwgZW5jb2Rpbmc6U2VyaWFsaXplZEVuY29kaW5nLCBpbnR5cGU6U2VyaWFsaXplZFR5cGUsIG91dHR5cGU6U2VyaWFsaXplZFR5cGUsIC4uLmFyZ3M6QXJyYXk8YW55Pik6c3RyaW5nIHtcbiAgICAgICAgaWYodHlwZW9mIHZhbHVlID09PSBcInVuZGVmaW5lZFwiKXtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkVycm9yIC0gU2VyaWFsaXphYmxlLmVuY29kZXI6IHZhbHVlIHBhc3NlZCBpcyB1bmRlZmluZWRcIik7XG4gICAgICAgIH1cbiAgICAgICAgaWYoZW5jb2RpbmcgIT09IFwiZGlzcGxheVwiKXtcbiAgICAgICAgICAgIG91dHR5cGUgPSBlbmNvZGluZztcbiAgICAgICAgfVxuICAgICAgICBsZXQgdmI6QnVmZmVyID0gdGhpcy50eXBlVG9CdWZmZXIodmFsdWUsIGludHlwZSwgLi4uYXJncyk7XG4gICAgICAgIHJldHVybiB0aGlzLmJ1ZmZlclRvVHlwZSh2Yiwgb3V0dHlwZSwgLi4uYXJncyk7XG4gICAgfVxuXG5cbiAgICBkZWNvZGVyKHZhbHVlOnN0cmluZywgZW5jb2Rpbmc6U2VyaWFsaXplZEVuY29kaW5nLCBpbnR5cGU6U2VyaWFsaXplZFR5cGUsIG91dHR5cGU6U2VyaWFsaXplZFR5cGUsIC4uLmFyZ3M6QXJyYXk8YW55Pik6YW55IHtcbiAgICAgICAgaWYodHlwZW9mIHZhbHVlID09PSBcInVuZGVmaW5lZFwiKXtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkVycm9yIC0gU2VyaWFsaXphYmxlLmRlY29kZXI6IHZhbHVlIHBhc3NlZCBpcyB1bmRlZmluZWRcIik7XG4gICAgICAgIH1cbiAgICAgICAgaWYoZW5jb2RpbmcgIT09IFwiZGlzcGxheVwiKSB7XG4gICAgICAgICAgICBpbnR5cGUgPSBlbmNvZGluZztcbiAgICAgICAgfSBcbiAgICAgICAgbGV0IHZiOkJ1ZmZlciA9IHRoaXMudHlwZVRvQnVmZmVyKHZhbHVlLCBpbnR5cGUsIC4uLmFyZ3MpO1xuICAgICAgICByZXR1cm4gdGhpcy5idWZmZXJUb1R5cGUodmIsIG91dHR5cGUsIC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIHNlcmlhbGl6ZShzZXJpYWxpemU6U2VyaWFsaXphYmxlLCB2bTpzdHJpbmcsIGVuY29kaW5nOlNlcmlhbGl6ZWRFbmNvZGluZyA9IFwiZGlzcGxheVwiLCBub3RlczpzdHJpbmcgPSB1bmRlZmluZWQpOm9iamVjdCB7XG4gICAgICAgIGlmKHR5cGVvZiBub3RlcyA9PT0gXCJ1bmRlZmluZWRcIil7XG4gICAgICAgICAgICBub3RlcyA9IHNlcmlhbGl6ZS5nZXRUeXBlTmFtZSgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB2bSxcbiAgICAgICAgICAgIGVuY29kaW5nLFxuICAgICAgICAgICAgdmVyc2lvbjogU0VSSUFMSVpBVElPTlZFUlNJT04sXG4gICAgICAgICAgICBub3RlcyxcbiAgICAgICAgICAgIGZpZWxkczogc2VyaWFsaXplLnNlcmlhbGl6ZShlbmNvZGluZylcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGRlc2VyaWFsaXplKGlucHV0Om9iamVjdCwgb3V0cHV0OlNlcmlhbGl6YWJsZSkge1xuICAgICAgICBvdXRwdXQuZGVzZXJpYWxpemUoaW5wdXRbXCJmaWVsZHNcIl0sIGlucHV0W1wiZW5jb2RpbmdcIl0pO1xuICAgIH1cbn0iXX0=